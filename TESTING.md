# IndexedDB 升级测试指南

本文档帮助你验证从 LocalStorage 到 IndexedDB 的升级是否成功。

---

## 🧪 快速测试步骤

### 1. 启动应用

```bash
npm run dev
```

### 2. 打开浏览器控制台

按 `F12` 打开开发者工具，查看控制台输出。

### 3. 验证初始化

如果之前有数据，应该看到类似输出：

```
开始从 localStorage 迁移数据...
成功迁移 X 条聊天记录
成功迁移设置数据
成功迁移模型选择
数据迁移完成！
已清除 localStorage 中的旧数据
IndexedDB 初始化成功
📊 存储使用情况: 15.32MB / 2048.00MB (0.75%)
```

如果是全新安装，应该看到：

```
IndexedDB 初始化成功
📊 存储使用情况: 0.02MB / 2048.00MB (0.00%)
```

---

## 🔍 详细验证

### 验证 1: IndexedDB 数据库创建

1. 打开开发者工具 → **Application** 标签页（Chrome/Edge）
2. 左侧菜单找到 **IndexedDB**
3. 展开应该看到 `AntigravityChat` 数据库
4. 展开数据库，应该看到两个对象存储：
   - `chatHistory` - 存储对话记录
   - `settings` - 存储设置信息

### 验证 2: 数据迁移完整性

如果之前有数据：

1. 在 **Application** → **IndexedDB** → **AntigravityChat** → **chatHistory** 中查看
2. 确认所有旧的对话记录都已迁移
3. 打开 **Application** → **Local Storage**
4. 确认 `chatgpt_history`、`chatgpt_settings`、`chatgpt_selected_model` 已被删除

### 验证 3: 基本功能测试

#### 3.1 创建新对话

1. 点击「新建对话」按钮
2. 发送一条测试消息（如果API已配置）
3. 刷新页面，确认对话仍然存在

#### 3.2 删除对话

1. 点击对话旁边的删除按钮
2. 刷新页面，确认对话已被删除

#### 3.3 清空历史

1. 点击侧边栏的「清空历史」
2. 确认对话框，点击「清空」
3. 刷新页面，确认所有对话都已清空

#### 3.4 设置保存

1. 点击「设置」按钮
2. 修改 API 配置或添加新模型
3. 保存设置并关闭
4. 刷新页面，确认设置已保存

#### 3.5 数据保留设置

1. 打开设置 → 数据管理标签页
2. 查看存储使用情况统计
3. 修改数据保留天数
4. 保存并确认过期数据被清理

### 验证 4: 存储容量测试

#### 查看当前存储使用情况

在浏览器控制台运行：

```javascript
navigator.storage.estimate().then(estimate => {
  console.log('已使用:', (estimate.usage / 1024 / 1024).toFixed(2), 'MB');
  console.log('总配额:', (estimate.quota / 1024 / 1024).toFixed(2), 'MB');
  console.log('使用率:', (estimate.usage / estimate.quota * 100).toFixed(2), '%');
});
```

#### 压力测试（可选）

创建多个对话并发送大量消息，验证大数据量下的性能：

1. 创建 10+ 个对话
2. 每个对话发送 50+ 条消息
3. 观察应用性能是否流畅
4. 刷新页面确认所有数据都已保存

---

## 🐛 常见问题排查

### 问题 1: 迁移失败

**现象**: 控制台显示迁移错误

**解决方案**:
1. 检查浏览器版本是否支持 IndexedDB
2. 查看控制台错误详情
3. 手动清除 LocalStorage 后重新加载

### 问题 2: 数据未保存

**现象**: 刷新页面后数据丢失

**解决方案**:
1. 检查 IndexedDB 是否被浏览器清除（隐私模式）
2. 查看控制台是否有数据库错误
3. 确认不是浏览器的「清除浏览历史」操作导致

### 问题 3: 存储容量不足

**现象**: 控制台显示 `QuotaExceededError`

**解决方案**:
1. 减少数据保留天数（设置 → 数据管理）
2. 手动删除不需要的对话
3. 清理其他网站的存储数据

### 问题 4: 性能问题

**现象**: 应用响应变慢

**可能原因**:
- 数据量过大（10000+ 条消息）
- 浏览器资源不足

**解决方案**:
1. 减少数据保留天数
2. 清理旧对话
3. 关闭其他标签页释放内存

---

## 📊 性能基准

### 预期性能指标

| 操作 | 响应时间 | 说明 |
|------|----------|------|
| 应用启动 | < 500ms | 加载聊天历史 |
| 创建对话 | < 100ms | 保存到 IndexedDB |
| 发送消息 | 1-2s | 包含防抖延迟 |
| 删除对话 | < 200ms | 从 IndexedDB 删除 |
| 清空历史 | < 500ms | 批量删除 |

### 数据量测试结果

| 对话数量 | 总消息数 | 数据大小 | 加载时间 |
|----------|----------|----------|----------|
| 10 | 100 | ~1MB | < 300ms |
| 50 | 500 | ~5MB | < 500ms |
| 100 | 1000 | ~10MB | < 800ms |
| 500 | 5000 | ~50MB | < 2s |

---

## ✅ 验收标准

完成以下检查项即表示升级成功：

- [ ] IndexedDB 数据库成功创建
- [ ] 旧数据（如果有）成功迁移
- [ ] LocalStorage 旧数据已清理
- [ ] 创建新对话功能正常
- [ ] 删除对话功能正常
- [ ] 清空历史功能正常
- [ ] 设置保存功能正常
- [ ] 页面刷新后数据持久化
- [ ] 控制台显示存储使用情况
- [ ] 设置页面显示存储统计信息
- [ ] 无 JavaScript 错误
- [ ] 性能符合预期

---

## 🔧 手动清理（如需要）

如果需要完全重置应用，在控制台运行：

```javascript
// 删除 IndexedDB 数据库
indexedDB.deleteDatabase('AntigravityChat');

// 清除 LocalStorage
localStorage.clear();

// 刷新页面
location.reload();
```

---

## 📝 测试报告模板

测试完成后可以填写：

```
测试环境：
- 浏览器：Chrome 120.0.0.0
- 操作系统：Windows 11
- 测试日期：2026-01-06

测试结果：
✅ IndexedDB 初始化成功
✅ 数据迁移完成（15条对话）
✅ 基本功能测试通过
✅ 存储信息显示正常
✅ 性能测试通过

存储使用情况：
- 已使用：15.32 MB
- 总配额：2048.00 MB
- 使用率：0.75%

问题记录：
无

建议：
建议在文档中添加更多关于数据导出的说明。
```

---

好运！如有问题欢迎提 Issue。

