# 数据迁移指南

## 📦 从 LocalStorage 到 IndexedDB

从 v1.1.0 版本开始，Antigravity Chat 已经从 LocalStorage 升级到 IndexedDB 存储系统。

---

## 🎯 为什么要迁移？

### LocalStorage 的限制

- ❌ **容量限制**: 通常只有 5-10MB
- ❌ **同步操作**: 大数据量时会阻塞 UI
- ❌ **容易溢出**: 对话多了容易报错 `QuotaExceededError`

### IndexedDB 的优势

- ✅ **大容量**: 支持 500MB - 数 GB 的存储空间
- ✅ **异步操作**: 不阻塞主线程，性能更好
- ✅ **结构化存储**: 支持索引和高效查询
- ✅ **更可靠**: 浏览器级别的事务支持

---

## 🔄 自动迁移

**好消息！** 你**无需手动操作**，应用会自动处理所有迁移工作。

### 迁移过程

1. **检测旧数据**
   - 检查 LocalStorage 中是否存在 `chatgpt_history`
   - 检查是否存在 `chatgpt_settings` 和 `chatgpt_selected_model`

2. **自动迁移**
   - 将所有聊天记录迁移到 IndexedDB
   - 将设置和模型选择迁移到 IndexedDB
   - 在控制台显示迁移进度

3. **清理旧数据**
   - 迁移成功后自动清理 LocalStorage
   - 释放浏览器存储空间

### 查看迁移日志

打开浏览器开发者工具（F12），在控制台可以看到类似日志：

```
开始从 localStorage 迁移数据...
成功迁移 25 条聊天记录
成功迁移设置数据
成功迁移模型选择
数据迁移完成！
已清除 localStorage 中的旧数据
📊 存储使用情况: 15.32MB / 2048.00MB (0.75%)
```

---

## 🛠️ 手动检查

如果你想确认迁移是否成功，可以：

### 方法 1: 开发者工具检查

1. 打开浏览器开发者工具（F12）
2. 切换到 **Application** 标签页（Chrome/Edge）或 **存储** 标签页（Firefox）
3. 在左侧找到 **IndexedDB** > **AntigravityChat**
4. 查看 `chatHistory` 和 `settings` 两个存储

### 方法 2: 控制台查看存储信息

在浏览器控制台运行：

```javascript
// 查看存储使用情况
navigator.storage.estimate().then(estimate => {
  console.log(`已使用: ${(estimate.usage / 1024 / 1024).toFixed(2)} MB`);
  console.log(`总配额: ${(estimate.quota / 1024 / 1024).toFixed(2)} MB`);
  console.log(`使用率: ${(estimate.usage / estimate.quota * 100).toFixed(2)}%`);
});
```

---

## ⚠️ 注意事项

### 浏览器兼容性

IndexedDB 在所有现代浏览器中都得到支持：

| 浏览器 | 最低版本 | 说明 |
|--------|----------|------|
| Chrome | 24+ | ✅ 完全支持 |
| Firefox | 16+ | ✅ 完全支持 |
| Safari | 10+ | ✅ 完全支持 |
| Edge | 12+ | ✅ 完全支持 |

### 隐私模式

- ⚠️ **隐私/无痕模式**: IndexedDB 在会话结束后会被清除
- ⚠️ **跨设备**: 数据仅存储在本地，不会同步到其他设备

### 清除浏览器数据

如果清除浏览器数据，IndexedDB 也会被清除：

- ✅ 清除 Cookies: 不影响 IndexedDB
- ✅ 清除缓存: 不影响 IndexedDB
- ❌ 清除网站数据: **会清除 IndexedDB**

---

## 🔧 故障排除

### 迁移失败怎么办？

如果迁移失败，应用会：

1. **继续使用旧数据**: LocalStorage 中的数据不会被删除
2. **显示错误日志**: 在控制台查看具体错误
3. **正常运行**: 不影响应用的正常使用

### 常见问题

#### Q: 迁移后找不到旧的对话记录？

**A**: 检查以下几点：
- 打开控制台查看是否有错误日志
- 检查 IndexedDB 中是否有数据（Application > IndexedDB）
- 尝试刷新页面

#### Q: 存储空间不够怎么办？

**A**: IndexedDB 的配额取决于浏览器和可用磁盘空间：
- Chrome/Edge: 可用磁盘的 60%
- Firefox: 可用磁盘的 50%
- Safari: 最多 1GB

如果空间不足，可以：
1. 减少数据保留天数（设置中修改）
2. 手动删除不需要的对话
3. 清理其他网站的存储数据

#### Q: 如何备份数据？

**A**: 目前版本暂不支持导出，但你可以：
- 通过浏览器开发者工具手动导出 IndexedDB 数据
- 等待 v1.2.0 版本的导出功能

---

## 📊 性能对比

| 指标 | LocalStorage | IndexedDB | 提升 |
|------|--------------|-----------|------|
| 存储容量 | ~10MB | 500MB+ | **50x+** |
| 写入速度 | 同步阻塞 | 异步非阻塞 | **更流畅** |
| 查询性能 | 全量解析 | 索引查询 | **更快** |
| 可靠性 | 无事务 | 事务支持 | **更安全** |

---

## 🎉 总结

- ✅ 迁移**完全自动**，无需手动操作
- ✅ 存储容量从 10MB 提升到 **500MB+**
- ✅ 性能更好，不阻塞 UI
- ✅ 支持海量对话数据
- ✅ 旧数据自动迁移，不会丢失

如有任何问题，欢迎提交 Issue！

