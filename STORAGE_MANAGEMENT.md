# 存储管理功能说明

## 📊 功能概览

在设置面板的「数据管理」标签页，用户可以查看详细的存储使用情况，并进行手动管理。

---

## 🎯 主要功能

### 1. 存储统计信息

#### 浏览器存储配额
显示 IndexedDB 的存储使用情况：

- **已使用空间** - 当前已使用的存储空间（MB）
- **总配额** - 浏览器分配的总存储空间（MB）
- **使用率** - 当前使用百分比

#### 可视化进度条
- 🟢 **绿色** (0-50%) - 使用正常
- 🟡 **黄色** (50-80%) - 使用较多
- 🔴 **红色** (80-100%) - 接近上限

### 2. 数据详情统计

显示实际数据量：

- **对话数量** - 保存的对话总数
- **消息总数** - 所有对话中的消息总数
- **估算大小** - 对话数据的估算大小（MB）

### 3. 手动管理功能

#### 🔄 刷新统计
- 点击右上角的刷新按钮
- 或点击底部的「刷新统计」按钮
- 实时更新所有存储信息

#### 🗑️ 清空所有数据
- 一键清空所有对话历史
- 包含二次确认，防止误操作
- **注意：此操作无法撤销！**

---

## 🎨 界面布局

```
┌─────────────────────────────────────────────┐
│ 📊 存储统计                    [刷新] 🔄 │
│ IndexedDB 本地存储，支持 500MB+ 大容量       │
├─────────────────────────────────────────────┤
│                                             │
│  已使用      总配额       使用率             │
│  15.32 MB   2048 MB     0.75%              │
│                                             │
│  存储使用进度                               │
│  ████░░░░░░░░░░░░░░░░░░ 15.32/2048 MB     │
│                                             │
│  数据详情                                   │
│  25 对话 | 156 消息 | 15.30 MB             │
│                                             │
│  [🗑️ 清空所有数据]  [刷新统计]            │
└─────────────────────────────────────────────┘
```

---

## 💡 使用场景

### 场景 1: 日常监控
定期查看存储使用情况，了解数据增长趋势。

**操作**:
1. 打开设置
2. 切换到「数据管理」标签页
3. 查看存储统计

### 场景 2: 存储空间不足
当使用率超过 80% 时，需要清理数据。

**操作**:
1. 查看数据详情，了解数据量
2. 调整「数据保存时间」（如从 30 天改为 7 天）
3. 或使用「清空所有数据」完全清理

### 场景 3: 性能优化
数据过多可能影响加载速度。

**操作**:
1. 查看对话数量和消息总数
2. 如果超过 1000 条对话，考虑清理
3. 使用自动清理（设置较短的保存天数）

### 场景 4: 数据迁移前
在迁移或重装前，查看当前数据量。

**操作**:
1. 查看存储统计
2. 记录对话数量和消息总数
3. 确认数据已备份（未来版本支持导出）

---

## 🔧 技术实现

### 存储信息获取

使用浏览器的 Storage API：

```javascript
async getStorageEstimate() {
    if ('storage' in navigator && 'estimate' in navigator.storage) {
        const estimate = await navigator.storage.estimate();
        return {
            usage: estimate.usage,           // 字节
            quota: estimate.quota,           // 字节
            usageInMB: (estimate.usage / (1024 * 1024)).toFixed(2),
            quotaInMB: (estimate.quota / (1024 * 1024)).toFixed(2),
            percentUsed: ((estimate.usage / estimate.quota) * 100).toFixed(2)
        };
    }
    return null;
}
```

### 数据统计计算

从内存中的 `history` 数组计算：

```javascript
const detailedStats = computed(() => {
    const totalChats = history.length;
    const totalMessages = history.reduce((sum, chat) =>
        sum + (chat.messages?.length || 0), 0);
    const estimatedSize = JSON.stringify(history).length / (1024 * 1024);

    return { totalChats, totalMessages, estimatedSize };
});
```

### 手动清理

调用 IndexedDB 的清空方法：

```javascript
const handleClearAllData = () => {
    // 显示确认对话框
    showConfirmDialog('清空所有数据', '⚠️ 此操作无法恢复！', 'danger', async () => {
        await dbManager.clearAllChats();  // 清空数据库
        history.value = [];                // 清空内存
        await refreshStorageInfo();        // 刷新统计
    });
};
```

---

## ⚠️ 注意事项

### 1. 估算大小 vs 实际大小

**估算大小**: 基于 JSON 字符串长度计算
**实际大小**: IndexedDB 实际占用（可能包含索引等额外开销）

两者可能有 10-20% 的差异，这是正常的。

### 2. 使用率异常

如果使用率显示 0% 或异常值：
- 浏览器可能不支持 Storage API
- 尝试刷新页面
- 查看浏览器控制台错误

### 3. 清空后数据恢复

**重要**: 清空操作是不可逆的！
- IndexedDB 中的数据将被永久删除
- 未来版本将支持导出/备份功能
- 建议清空前确认不需要这些数据

### 4. 自动清理 vs 手动清理

| 特性 | 自动清理 | 手动清理 |
|------|----------|----------|
| 触发时机 | 启动时、修改设置时 | 用户手动点击 |
| 清理范围 | 仅删除过期数据 | 删除所有数据 |
| 可配置性 | 可设置天数 | 无配置 |
| 风险性 | 低 | 高（不可恢复） |

---

## 📈 存储容量说明

### 不同浏览器的配额

| 浏览器 | 存储配额 | 说明 |
|--------|----------|------|
| **Chrome/Edge** | 可用磁盘的 60% | 动态分配，通常数 GB |
| **Firefox** | 可用磁盘的 50% | 用户可在设置中查看 |
| **Safari** | 最多 1GB | iOS 设备可能更少 |
| **Opera** | 可用磁盘的 60% | 与 Chrome 类似 |

### 实际可用空间

假设你的磁盘剩余空间为 100GB：

- **Chrome/Edge**: ~60GB
- **Firefox**: ~50GB
- **Safari**: 最多 1GB

对于聊天应用，通常情况下：
- 1000 条对话 ≈ 10-50MB
- 10000 条消息 ≈ 20-100MB
- 1GB 可存储 10000+ 条对话

---

## 🎓 最佳实践

### 1. 定期监控

建议每月查看一次存储使用情况：
- 使用率 < 50%: 无需担心
- 使用率 50-80%: 考虑清理旧数据
- 使用率 > 80%: 建议立即清理

### 2. 合理设置保留时间

根据实际需求选择：
- **3天**: 临时使用，不需要长期保存
- **7天**: 日常使用，保留最近对话（推荐）
- **30天**: 重要对话，需要长期参考

### 3. 定期清理

如果对话不再需要：
- 可单独删除（侧边栏的删除按钮）
- 或使用「清空所有数据」完全清理
- 未来版本将支持批量删除

### 4. 性能优化

数据量对性能的影响：
- < 100 条对话: 无影响
- 100-500 条: 略微影响启动速度
- 500-1000 条: 可能需要 1-2 秒加载
- \> 1000 条: 建议清理

---

## 🚀 未来功能计划

### v1.2.0 (计划中)
- ✅ 导出对话记录（JSON/Markdown）
- ✅ 批量删除对话
- ✅ 按日期范围删除
- ✅ 数据压缩功能

### v1.3.0 (计划中)
- ✅ 云端备份（可选）
- ✅ 对话归档功能
- ✅ 智能清理建议
- ✅ 存储趋势图表

---

## 🔗 相关文档

- [README.md](./README.md) - 项目说明
- [MIGRATION.md](./MIGRATION.md) - 数据迁移指南
- [UPGRADE_SUMMARY.md](./UPGRADE_SUMMARY.md) - IndexedDB 升级说明

---

## 💬 反馈

如有任何问题或建议，欢迎：
- 提交 GitHub Issue
- 在讨论区发帖
- 联系维护者

---

**版本**: v1.1.0+
**更新日期**: 2026-01-06
**状态**: ✅ 已实现

